<!doctype html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Please Hold</title>
  <link rel="stylesheet" href="/static/css/main.css">
  <link rel="stylesheet" href="/static/css/hold.css">
</head>

<body>
  <header>
    <a href="/"><h1 style="color:white">Add my lyrics</h1></a>
    <nav>
        <a href="/">Add lyrics</a>
        <a href="/contact">Contact</a>
    </nav>
  </header>
  <main>
    <section>
      <article>
        <h2 id="head">Please hold while we render your video</h2>
        <a href="/">Add lyrics to another video?</a>
      </article>
      <article>
        <div id="myProgress">
          <div id="myBar" style="width: 0%"></div>
        </div>
      </article>
    </section>
  </main>
</body>

<script>
  const video_id = '{{ video_id }}';

  function deleteCookie(cname) {
    var name = cname + "="
    var decodedCookie = decodeURIComponent(document.cookie)
    var ca = decodedCookie.split(';')
    for(var i = 0; i <ca.length; i++) {
      var c = ca[i]
      while (c.charAt(0) == ' ') {
        c = c.substring(1)
      }
      if (c.indexOf(name) == 0) {
        // Found cookie with cname
        document.cookie = name + "; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"
        return
      }
    }
    return
}

  function deleteTimingInfo() {
    regStart = /(start_[0-9]|stop_[0-9])/g
    while ((match = regStart.exec(document.cookie)) != null) {
        deleteCookie(match[0])
    }
    deleteCookie("lyricsArea")
  }

  function progressBar(target) {
    var elem = document.getElementById("myBar")
    var width = parseInt(elem.style.width.replace("%", ""))
    var target = parseInt(target)
    var id = setInterval(frame, 50)
    console.log(id)
    function frame() {
      if (width >= target) {
        clearInterval(id)
      } else {
        if (target > width) {
          width++
        } else {
          width--
        }
        elem.style.width = width + "%"
      }
    }
  }

  function request() {
    console.log("starting request...")
    fetch('/get_file?videoID='.concat(video_id))
      .then(response => response.json())
      .then(data => {
        console.log(data['progress'])
        if (data['progress'] == "ERROR") {
          document.getElementById("head").innerHTML = "Somthing went wrong, sorry for the inconvenience"
        } else {
          progressBar(data['progress'])
          if (data['progress'] == "100" && !downloaded) {
            downloaded == true
            clearInterval(timerID)
            window.location.href = "/download?videoID=".concat(video_id)
            document.title = "Your download should begin shortly"
            document.getElementById("head").innerHTML = "You download should begin shortly"
          }
        }
      })
      .catch((error) => {
        console.error('Error:', error);
      });
  }
  deleteTimingInfo()
  var downloaded = false
  timerID = setInterval(request, 2000)
  request()

</script>